<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiwai Tiktok Order Management</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap">
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet">
    <!-- Add Custom CSS -->
    <link href="styles.css" rel="stylesheet">
    <script>
        async function checkAuth() {
            const response = await fetch('/api/check-auth', { credentials: 'include' });
            const data = await response.json();
    
            if (!data.isLoggedIn) {
                window.location.href = 'login.html';
            }
        }
    
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
    
</head>


<body>
    <!-- Navbar Section -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="img/bxl--tiktok.png" alt="icon" height="30" style="padding-bottom: 5px;" /> Order Management</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">ดูประวัติการขาย</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="upload.html">อัพโหลดและส่งข้อมูล</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="uploadview.html">ดูข้อมูลใน AS400</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">ตั้งค่า</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">ออกจากระบบ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container">
        <h3>TikTok Order Viewer</h3>


        <!-- Filter Section -->
        <div class="row justify-content-between mb-3">
            <div class="col-md-10 filter-bar">
                <div class="row">
                    <div class="col-md-3 mb-1">
                        <input type="date" id="startDate" class="form-control" placeholder="Start Date" onclick="this.showPicker()">
                    </div>
                    <div class="col-md-3 mb-1">
                        <input type="date" id="endDate" class="form-control" placeholder="End Date" onclick="this.showPicker()">
                    </div>
                    <div class="col-md-3 mb-1">
                        <select id="sortBy" class="form-select">
                            <option value="Upload Date">ค้นหาตามวันที่ส่งข้อมูล</option>
                            <option value="Created Time">ค้นหาตามวันที่สั่งซื้อ</option>
                            <option value="Paid Time">ค้นหาตามวันที่ชำระเงิน</option>
                            <option value="Shipped Time">ค้นหาตามวันที่จัดส่ง</option>
                            <option value="Delivered Time">ค้นหาตามวันที่ส่งสำเร็จ</option>
                        </select>
                    </div>
                    <div class="col-md-1 mb-1">
                        <button class="btn btn-search w-90 h-20" onclick="fetchOrders()">
                            <!--<i class='bx bx-search'></i> -->ค้นหา
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-1">
                <button class="btn btn-light w-120" data-bs-toggle="modal" data-bs-target="#fieldSelectionModal">
                    <i class='bx bx-cog'></i> ฟิลด์
                </button>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-responsive">
            <table id="orderTable" class="table table-bordered">
                <thead>
                    <tr id="tableHeader">
                        <th data-field="created_time">วันที่สั่งซื้อ</th>
                        <th data-field="buyer_username">ชื่อผู้ซื้อ</th>
                        <th data-field="order_id">หมายเลขคำสั่งซื้อ</th>
                        <th data-field="order_status">สถานะคำสั่งซื้อ</th>
                        <th data-field="sku_id">รหัส SKU</th>
                        <th data-field="seller_sku">รหัส SKU ผู้ขาย</th>
                        <th data-field="product_name">ชื่อสินค้า</th>
                        <th data-field="quantity">จำนวน</th>
                        <th data-field="sku_unit_original_price">ราคาต่อหน่วย</th>
                        <th data-field="sku_seller_discount">ส่วนลดจากผู้ขาย</th>
                        <th data-field="sku_subtotal_after_discount">ยอดรวมหลังหักส่วนลด</th>
                        <th data-field="shipping_provider_name">ชื่อผู้ให้บริการจัดส่ง</th>
                        <th data-field="payment_method">วิธีการชำระเงิน</th>
                        <th data-field="province">จังหวัด</th>
                        <th data-field="zipcode">รหัสไปรษณีย์</th>
                        <th data-field="paid_time">เวลาที่ชำระเงิน</th>
                        <th data-field="rts_time">เวลาพร้อมจัดส่ง</th>
                        <th data-field="shipped_time">เวลาในการจัดส่ง</th>
                        <th data-field="delivered_time">เวลาที่ส่งถึง</th>
                        <th data-field="uploaddate">วันที่อัปโหลด</th>
                        <th data-field="getflg">สถานะการดึงข้อมูล</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Section -->
        <div class="pagination">
            <button id="prevButton" class="btn btn-outline-secondary" onclick="previousPage()" disabled>Previous</button>
            <button id="nextButton" class="btn btn-outline-secondary" onclick="nextPage()" disabled>Next</button>
        </div>
    </div>

    <!-- Modal for Field Selection -->
    <div class="modal fade" id="fieldSelectionModal" tabindex="-1" aria-labelledby="fieldSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fieldSelectionModalLabel">Select Fields to Display</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="fieldSelectionForm">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="created_time" id="fieldCreatedTime">
                            <label class="form-check-label" for="fieldCreatedTime">
                                วันที่สั่งซื้อ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="buyer_username" id="fieldBuyerUsername">
                            <label class="form-check-label" for="fieldBuyerUsername">
                                ชื่อผู้ซื้อ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="order_id" id="fieldOrderId">
                            <label class="form-check-label" for="fieldOrderId">
                                หมายเลขคำสั่งซื้อ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="order_status" id="fieldOrderStatus">
                            <label class="form-check-label" for="fieldOrderStatus">
                                สถานะคำสั่งซื้อ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="sku_id" id="fieldSkuId">
                            <label class="form-check-label" for="fieldSkuId">
                                รหัส SKU
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="seller_sku" id="fieldSellerSku">
                            <label class="form-check-label" for="fieldSellerSku">
                                รหัส SKU ผู้ขาย
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="product_name" id="fieldProductName">
                            <label class="form-check-label" for="fieldProductName">
                                ชื่อสินค้า
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="quantity" id="fieldQuantity">
                            <label class="form-check-label" for="fieldQuantity">
                                จำนวน
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="sku_unit_original_price" id="fieldSkuUnitOriginalPrice">
                            <label class="form-check-label" for="fieldSkuUnitOriginalPrice">
                                ราคาต่อหน่วย
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="sku_seller_discount" id="fieldSkuSellerDiscount">
                            <label class="form-check-label" for="fieldSkuSellerDiscount">
                                ส่วนลดจากผู้ขาย
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="sku_subtotal_after_discount" id="fieldSkuSubtotalAfterDiscount">
                            <label class="form-check-label" for="fieldSkuSubtotalAfterDiscount">
                                ยอดรวมหลังหักส่วนลด
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="shipping_provider_name" id="fieldShippingProviderName">
                            <label class="form-check-label" for="fieldShippingProviderName">
                                ชื่อผู้ให้บริการจัดส่ง
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="payment_method" id="fieldPaymentMethod">
                            <label class="form-check-label" for="fieldPaymentMethod">
                                วิธีการชำระเงิน
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="province" id="fieldProvince">
                            <label class="form-check-label" for="fieldProvince">
                                จังหวัด
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="zipcode" id="fieldZipcode">
                            <label class="form-check-label" for="fieldZipcode">
                                รหัสไปรษณีย์
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="paid_time" id="fieldPaidTime">
                            <label class="form-check-label" for="fieldPaidTime">
                                เวลาที่ชำระเงิน
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="rts_time" id="fieldRtsTime">
                            <label class="form-check-label" for="fieldRtsTime">
                                เวลาพร้อมจัดส่ง
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="shipped_time" id="fieldShippedTime">
                            <label class="form-check-label" for="fieldShippedTime">
                                เวลาในการจัดส่ง
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="delivered_time" id="fieldDeliveredTime">
                            <label class="form-check-label" for="fieldDeliveredTime">
                                เวลาที่ส่งถึง
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="uploaddate" id="fieldUploadDate">
                            <label class="form-check-label" for="fieldUploadDate">
                                วันที่อัปโหลด
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="getflg" id="fieldGetFlg">
                            <label class="form-check-label" for="fieldGetFlg">
                                สถานะการดึงข้อมูล
                            </label>
                        </div>
                    </form>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="applyFieldSelection()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;

        //วันที่ย้อนหลังไป 1 วัน
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayFormatted = yesterday.toISOString().split('T')[0];
        // Set default dates to today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = yesterdayFormatted;
        document.getElementById('endDate').value = today;

        document.addEventListener('DOMContentLoaded', () => {
            loadFieldSelection(); // โหลดฟิลด์ที่เลือกเมื่อหน้าเว็บโหลดเสร็จ
        });

        async function fetchOrders() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const sortBy = document.getElementById('sortBy').value;

            // ตั้งค่า currentPage ให้เป็น 1 ทุกครั้งที่มีการค้นหาใหม่
            if (arguments.length === 0) {
                currentPage = 1;
            }

            const response = await fetch(`/api/orders?startDate=${startDate} 00:00:00&endDate=${endDate} 23:59:59&sortBy=${sortBy}&page=${currentPage}`);
            const orders = await response.json();

            const tbody = document.getElementById('orderTable').querySelector('tbody');
            tbody.innerHTML = '';

            // ตรวจสอบจำนวนรายการที่ได้รับมา หากน้อยกว่า 20 แสดงว่าไม่มีหน้าถัดไป
            const hasNextPage = orders.length === 20;

            orders.forEach(order => {
                const row = `
                    <tr>
                        ${document.querySelector('#tableHeader [data-field="created_time"]').style.display !== 'none' ? `<td>${new Date(order.created_time).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="buyer_username"]').style.display !== 'none' ? `<td>${order.buyer_username}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="order_id"]').style.display !== 'none' ? `<td>${order.order_id}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="order_status"]').style.display !== 'none' ? `<td>${order.order_status}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="sku_id"]').style.display !== 'none' ? `<td>${order.sku_id}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="seller_sku"]').style.display !== 'none' ? `<td>${order.seller_sku}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="product_name"]').style.display !== 'none' ? `<td>${order.product_name}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="quantity"]').style.display !== 'none' ? `<td>${order.quantity}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="sku_unit_original_price"]').style.display !== 'none' ? `<td>${order.sku_unit_original_price}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="sku_seller_discount"]').style.display !== 'none' ? `<td>${order.sku_seller_discount}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="sku_subtotal_after_discount"]').style.display !== 'none' ? `<td>${order.sku_subtotal_after_discount}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="shipping_provider_name"]').style.display !== 'none' ? `<td>${order.shipping_provider_name}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="payment_method"]').style.display !== 'none' ? `<td>${order.payment_method}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="province"]').style.display !== 'none' ? `<td>${order.province}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="zipcode"]').style.display !== 'none' ? `<td>${order.zipcode}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="paid_time"]').style.display !== 'none' ? `<td>${new Date(order.paid_time).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="rts_time"]').style.display !== 'none' ? `<td>${new Date(order.rts_time).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="shipped_time"]').style.display !== 'none' ? `<td>${new Date(order.shipped_time).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="delivered_time"]').style.display !== 'none' ? `<td>${new Date(order.delivered_time).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="uploaddate"]').style.display !== 'none' ? `<td>${new Date(order.uploaddate).toLocaleString('en-GB', { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>` : ''}
                        ${document.querySelector('#tableHeader [data-field="getflg"]').style.display !== 'none' ? `<td>${order.getflg}</td>` : ''}
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // จัดการปุ่ม Next
            const nextButton = document.getElementById('nextButton');
            if (hasNextPage) {
                nextButton.disabled = false;
            } else {
                nextButton.disabled = true;
            }

            // จัดการปุ่ม Previous
            const prevButton = document.getElementById('prevButton');
            if (currentPage > 1) {
                prevButton.disabled = false;
            } else {
                prevButton.disabled = true;
            }
        }

        function applyFieldSelection() {
            const checkboxes = document.querySelectorAll('#fieldSelectionForm input[type="checkbox"]');
            const tableHeader = document.getElementById('tableHeader').children;

            const selectedFields = []; // สร้าง array สำหรับเก็บฟิลด์ที่เลือก

            checkboxes.forEach((checkbox, index) => {
                tableHeader[index].style.display = checkbox.checked ? '' : 'none';

                if (checkbox.checked) {
                    selectedFields.push(checkbox.value); // เก็บชื่อฟิลด์ที่เลือกไว้
                }
            });

            // บันทึกการเลือกฟิลด์ไว้ใน localStorage
            localStorage.setItem('selectedFields', JSON.stringify(selectedFields));

            fetchOrders();
            document.querySelector('.btn-close').click(); // ปิด modal หลังจาก apply
        }

        function loadFieldSelection() {
            const selectedFields = JSON.parse(localStorage.getItem('selectedFields')) || ['created_time', 'buyer_username', 'order_id', 'order_status', 'seller_sku', 'product_name', 'quantity', 'sku_unit_original_price', 'sku_seller_discount', 'sku_subtotal_after_discount', 'payment_method', 'province', 'zipcode', 'shipped_time', 'uploaddate'];

            console.log('selectedFields : ',selectedFields );

            const checkboxes = document.querySelectorAll('#fieldSelectionForm input[type="checkbox"]');
            const tableHeader = document.getElementById('tableHeader').children;

            checkboxes.forEach((checkbox, index) => {
                const isChecked = selectedFields.includes(checkbox.value);
                checkbox.checked = isChecked;
                tableHeader[index].style.display = isChecked ? '' : 'none';
            });
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                fetchOrders(true);
            }
        }

        function nextPage() {
            currentPage++;
            fetchOrders(true);
        }

        
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST', // เปลี่ยนเป็น POST เพื่อความปลอดภัย
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // ถ้าใช้ cookies ในการทำงานร่วมกัน
                });

                if (response.ok) {
                    window.location.href = 'login.html'; // นำผู้ใช้ไปยังหน้า login เมื่อ logout สำเร็จ
                } else {
                    // จัดการกับกรณี response status code ไม่ใช่ 200 OK
                    document.getElementById('error').textContent = 'Failed to log out. Please try again.';
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                // จัดการกับข้อผิดพลาดที่เกิดขึ้นจาก fetch
                document.getElementById('error').textContent = 'An unexpected error occurred. Please try again later.';
                document.getElementById('error').style.display = 'block';
                console.error('Logout error:', error);
            }
        }


        

        async function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            // ตรวจสอบว่าได้เลือกไฟล์หรือยัง
            if (!file) {
                alert('กรุณาเลือกไฟล์ก่อนทำการอัพโหลด');
                return;
            }

            // ตรวจสอบนามสกุลไฟล์ว่าถูกต้องหรือไม่ (ต้องเป็น .csv)
            const allowedExtensions = /(\.csv)$/i;
            if (!allowedExtensions.exec(file.name)) {
                alert('กรุณาอัพโหลดไฟล์ที่มีนามสกุล .csv เท่านั้น');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('CSV file successfully uploaded');
                    fetchOrders();  // Re-fetch orders after uploading
                } else {
                    const errorMsg = await response.text();
                    alert(`Failed to upload CSV file: ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error uploading CSV file:', error);
                alert('Error uploading CSV file');
            }
        }




        // Initial fetch
        fetchOrders();
    </script>
    <!-- Add Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
